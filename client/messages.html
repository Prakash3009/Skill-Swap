<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Message thread for mentorship request">
    <title>Messages - SkillSwap</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/chatbot.css">
    <style>
        .message-thread {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
        }

        .message-item {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
        }

        .message-item.own {
            background: var(--primary-light);
            margin-left: 2rem;
        }

        .message-item.other {
            background: var(--bg-secondary);
            margin-right: 2rem;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .message-text {
            margin: 0.5rem 0;
            line-height: 1.5;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">
                <img src="img/logo.png" alt="SkillSwap" class="brand-logo">
            </a>
            <ul class="navbar-nav">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="requests.html" class="nav-link">My Requests</a></li>
                <li><a href="profile.html" class="nav-link">My Profile</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: 2rem 0;">
        <div class="d-flex justify-between align-center mb-3">
            <h1>üí¨ Messages</h1>
            <a href="requests.html" class="btn btn-secondary btn-sm">‚Üê Back to Requests</a>
        </div>

        <div id="request-info" class="card mb-3" style="display: none;">
            <div class="card-body">
                <h3 id="request-title" style="margin-bottom: 0.5rem;"></h3>
                <p id="request-participants" class="text-muted" style="margin: 0;"></p>
            </div>
        </div>

        <!-- Schedule Meeting Section -->
        <div class="card mb-3">
            <div class="card-header">
                <h2 class="card-title">üìÖ Schedule Meeting</h2>
            </div>
            <div class="card-body">
                <form id="schedule-form">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="meeting-date" class="form-label">Date</label>
                            <input type="date" id="meeting-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="meeting-time" class="form-label">Time</label>
                            <input type="time" id="meeting-time" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="meeting-note" class="form-label">Meeting Details (Optional)</label>
                        <input type="text" id="meeting-note" class="form-control"
                            placeholder="e.g., Google Meet link, Offline location">
                    </div>
                    <button type="submit" class="btn btn-primary">Propose Schedule</button>
                </form>
            </div>
        </div>

        <!-- Messages Section -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Messages</h2>
                <p class="text-muted">Simple message thread (refresh to see new messages)</p>
            </div>
            <div class="card-body">
                <div id="messages-thread" class="message-thread">
                    <div class="loading-container">
                        <div class="spinner"></div>
                    </div>
                </div>

                <form id="send-message-form">
                    <div class="d-flex gap-2">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your message..."
                            required>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="js/main.js"></script>
    <script src="js/chatbot.js"></script>
    <script>
        const API_URL = '/api';
        let currentUserId = null;
        let requestId = null;
        let requestData = null;

        document.addEventListener('DOMContentLoaded', () => {
            currentUserId = localStorage.getItem('userId');
            if (!currentUserId) {
                showAlert('Please login first', 'warning');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            // Get request ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            requestId = urlParams.get('id');

            if (!requestId) {
                showAlert('No request specified', 'danger');
                setTimeout(() => window.location.href = 'requests.html', 2000);
                return;
            }

            loadRequestInfo();
            loadMessages();
        });

        // Load request info
        async function loadRequestInfo() {
            try {
                const response = await fetch(`${API_URL}/requests/user/${currentUserId}`);
                const result = await response.json();

                if (result.success) {
                    // Find the specific request
                    const allRequests = [...result.data.incoming, ...result.data.outgoing];
                    requestData = allRequests.find(r => r._id === requestId);

                    if (requestData) {
                        document.getElementById('request-info').style.display = 'block';
                        document.getElementById('request-title').textContent =
                            `Skill: ${requestData.skillId.skillName}`;

                        const isLearner = requestData.learnerId._id === currentUserId;
                        const otherPerson = isLearner ? requestData.mentorId : requestData.learnerId;

                        document.getElementById('request-participants').textContent =
                            `Chatting with: ${otherPerson.name} (${otherPerson.email})`;
                    }
                }
            } catch (error) {
                console.error('Error loading request info:', error);
            }
        }

        // Load messages
        async function loadMessages() {
            const container = document.getElementById('messages-thread');

            try {
                const response = await fetch(`${API_URL}/requests/${requestId}/messages`);
                const result = await response.json();

                if (result.success) {
                    displayMessages(result.data);
                } else {
                    container.innerHTML = '<p class="text-muted">No messages yet. Start the conversation!</p>';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                container.innerHTML = '<p class="text-danger">Failed to load messages</p>';
            }
        }

        // Display messages
        function displayMessages(messages) {
            const container = document.getElementById('messages-thread');

            if (messages.length === 0) {
                container.innerHTML = '<p class="text-muted">No messages yet. Start the conversation!</p>';
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isOwn = msg.senderId._id === currentUserId;
                return `
                    <div class="message-item ${isOwn ? 'own' : 'other'}">
                        <div class="message-sender">${msg.senderId.name}</div>
                        <div class="message-text">${msg.message}</div>
                        <div class="message-time">${timeAgo(msg.createdAt)}</div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Send message
        document.getElementById('send-message-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const message = document.getElementById('message-input').value;

            try {
                const response = await fetch(`${API_URL}/requests/${requestId}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        senderId: currentUserId,
                        message
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('message-input').value = '';
                    loadMessages(); // Reload messages
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('Failed to send message', 'danger');
            }
        });

        // Schedule meeting
        document.getElementById('schedule-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                date: document.getElementById('meeting-date').value,
                time: document.getElementById('meeting-time').value,
                note: document.getElementById('meeting-note').value
            };

            try {
                const response = await fetch(`${API_URL}/requests/${requestId}/schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Meeting schedule proposed successfully!', 'success');
                    e.target.reset();
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                console.error('Error scheduling:', error);
                showAlert('Failed to schedule meeting', 'danger');
            }
        });

        // Auto-refresh messages every 10 seconds (simple polling)
        setInterval(loadMessages, 10000);
    </script>
</body>

</html>